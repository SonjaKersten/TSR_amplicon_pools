---
title: "Slim_simulations_lasting"
output: html_document
date: '2022-12-17'
---

```{r}

DIRECTORY <- "/Volumes/abt6_projects8/alopecurus_popgen/data/Slim_simulations_TSR_lasting_CORRECTED"
POPULATION_SIZE <- 21000
DOMINANCE <- 0.5


simulations_lasting <- function(DIRECTORY = "/Volumes/abt6_projects8/alopecurus_popgen/data/Slim_simulations_TSR_lasting_CORRECTED", POPULATION_SIZE = 21000, DOMINANCE = 0.5){
  
  library(readr)
  Simulations_all <- read_table2(paste0(DIRECTORY, "/", POPULATION_SIZE, "_dom_", DOMINANCE, "/All_runs_", POPULATION_SIZE, "_", DOMINANCE, ".txt"), col_names=FALSE)

  colnames(Simulations_all) [2] <- "Generation"
  colnames(Simulations_all) [8] <- "Sel_Coeff"

  # Generate relevant analysis parameters
  Simulations_all$Allele_freq <- Simulations_all$X12/(POPULATION_SIZE * 2)      # Is this 21,000 times 2X ?

  Simulations_all$Run <- sapply(strsplit(as.character(Simulations_all$X1), "[.]"), "[", 3)

  Simulations_all$Mut_freq <- as.numeric(paste(0, sapply(strsplit(as.character(Simulations_all$X1), "[.]"), "[", 5 ), sep='.'))  

  Simulations_all$Run_Identifier <- paste(Simulations_all$Run, Simulations_all$Mut_freq, Simulations_all$Sel_Coeff, sep = "_")

  Simulations_all$Sel_Coeff <- as.factor(Simulations_all$Sel_Coeff)

  # Create unique identifier
  Simulations_all$Unique_Identifier <- paste(Simulations_all$Run, Simulations_all$Generation, Simulations_all$Mut_freq, Simulations_all$Sel_Coeff, sep="_")

  # Generation of a base data frame
  base_df1 <- data.frame( Sel_Coeff = as.factor(rep(c(0, -0.05, -0.1, -0.2, -0.3, -0.4), times = 4)), Mut_freq = rep(c(0.05, 0.10, 0.40, 0.70), each = 6))  

  # Repeat data frame as many runs needed
  base_df2 <- base_df1[rep(seq_len(nrow(base_df1)), each = 400), ]
  # Add Run column
  base_df2$Run <- rep(seq(1:400), times = 24)

  # Repeat data frame as many generations needed
  base_df3 <- base_df2[rep(seq_len(nrow(base_df2)), each = 2000), ]
  # Add Generation column
  base_df3$Generation <- rep(seq(1:2000), times = 4*6*400)

  # Unique identifier per row
  base_df3$Unique_Identifier <- paste(base_df3$Run, base_df3$Generation, base_df3$Mut_freq, base_df3$Sel_Coeff, sep="_")

  # Merge with real data
  start_time <- Sys.time()
  Simulations_complete <- merge(base_df3, Simulations_all, by = "Unique_Identifier", all.x = TRUE)
  end_time <- Sys.time()
  end_time - start_time

  # Convert NA's to 0's
  Simulations_complete$Allele_freq <- sapply(Simulations_complete$Allele_freq, FUN = function(x){if(is.na(x)){x<-0}else{x<-x}})

  Simulations_complete1 <- Simulations_complete[ ,c(1,2,3,4,5,18,21)]
  Simulations_complete1$Sel_Coeff.x <- factor(Simulations_complete1$Sel_Coeff.x, levels = c("0", "-0.05", "-0.1", "-0.2","-0.3", "-0.4"))
  
  ###########################
  ## Calculate mean values ##
  sim_mean <- aggregate(Simulations_complete1$Allele_freq , by=list(Simulations_complete1$Generation.x, Simulations_complete1$Sel_Coeff.x, Simulations_complete1$Mut_freq.x), FUN = mean)
  colnames(sim_mean) <- c('Generation',  'Sel_Coeff', 'Mut_freq', 'Mean')

  sim_sd <- aggregate(Simulations_complete1$Allele_freq , by=list(Simulations_complete1$Generation.x, Simulations_complete1$Sel_Coeff.x, Simulations_complete1$Mut_freq.x), FUN = sd)
  colnames(sim_sd) <- c('Generation',  'Sel_Coeff', 'Mut_freq', 'sd')

  sim_mean_sd <- merge(sim_mean, sim_sd, by=c('Generation',  'Sel_Coeff', 'Mut_freq')) 

  # Subset mean for allele frequency 0
  mean_0 <- subset(sim_mean_sd, Mean == 0)
  summary_table <- aggregate(mean_0$Generation, list(mean_0$Sel_Coeff, mean_0$Mut_freq), min)

  ##                       ##
  ###########################
  
  ###########################
  ## Alternative calculation over min Generation (when allele freq reaches 0) for each single Run, then mean over 400 runs

  # Subset all Generations of all single runs in which the allele freq became 0
  Simulations_complete1_0 <- subset(Simulations_complete1, Allele_freq==0)

  # Take the min Generation of each Run (that's the first generation of each Run, when the allele freq became 0 (cross with x axis))
  Simulations_complete1_0_min <- aggregate(Simulations_complete1_0$Generation, list(Simulations_complete1_0$Sel_Coeff.x, Simulations_complete1_0$Mut_freq.x, Simulations_complete1_0$Run.x), min)
  colnames(Simulations_complete1_0_min) <- c('Sel_Coeff',  'Mut_freq', 'Run','Generation')

  # Count the data entries for each combination (400 runs is the expected value for selection coefficients other than 0)
  print(table(Simulations_complete1_0_min$Sel_Coeff, Simulations_complete1_0_min$Mut_freq))

  # calculate mean over 400 runs
  sim_mean_Gen <- aggregate(Simulations_complete1_0_min$Generation , by=list(Simulations_complete1_0_min$Sel_Coeff, Simulations_complete1_0_min$Mut_freq), FUN = mean)
  colnames(sim_mean_Gen) <- c('Sel_Coeff', 'Mut_freq', 'Generation_Mean')

  # Calculate sd over 400 runs
  sim_sd_Gen <- aggregate(Simulations_complete1_0_min$Generation , by=list(Simulations_complete1_0_min$Sel_Coeff, Simulations_complete1_0_min$Mut_freq), FUN = sd)
  colnames(sim_sd_Gen) <- c('Sel_Coeff', 'Mut_freq', 'Generation_sd')

  # Combine mean and sd
  sim_mean_sd_Gen <- merge(sim_mean_Gen, sim_sd_Gen, by=c('Sel_Coeff',  'Mut_freq'))
  sim_mean_sd_Gen$Population_size <- POPULATION_SIZE
  sim_mean_sd_Gen$Dominance <- DOMINANCE
  
  
  ## Save outputs
  write.table(sim_mean_sd_Gen, file =paste0(POPULATION_SIZE, "_dom_", DOMINANCE, "/", "All_runs_", POPULATION_SIZE, "_", DOMINANCE, ".txt"), sep ="\t", row.names = FALSE, quote = FALSE)
  
  save.image(file = paste0(POPULATION_SIZE, "_dom_", DOMINANCE, "/", "All_runs_", POPULATION_SIZE, "_", DOMINANCE, ".RData"))

}

```


```{r}

simulations_lasting(DIRECTORY = "/Volumes/abt6_projects8/alopecurus_popgen/data/Slim_simulations_TSR_lasting_CORRECTED", POPULATION_SIZE = 42000, DOMINANCE = 0.5)
simulations_lasting(DIRECTORY = "/Volumes/abt6_projects8/alopecurus_popgen/data/Slim_simulations_TSR_lasting_CORRECTED", POPULATION_SIZE = 42000, DOMINANCE = 0.25)

#simulations_lasting(DIRECTORY = "/Volumes/abt6_projects8/alopecurus_popgen/data/Slim_simulations_TSR_lasting_CORRECTED", POPULATION_SIZE = 21000, DOMINANCE = 0.5)
simulations_lasting(DIRECTORY = "/Volumes/abt6_projects8/alopecurus_popgen/data/Slim_simulations_TSR_lasting_CORRECTED", POPULATION_SIZE = 21000, DOMINANCE = 0.25)


simulations_lasting(DIRECTORY = "/Volumes/abt6_projects8/alopecurus_popgen/data/Slim_simulations_TSR_lasting_CORRECTED", POPULATION_SIZE = 10500, DOMINANCE = 0.5)
simulations_lasting(DIRECTORY = "/Volumes/abt6_projects8/alopecurus_popgen/data/Slim_simulations_TSR_lasting_CORRECTED", POPULATION_SIZE = 10500, DOMINANCE = 0.25)





```

```{r}

```

```{r}

```


```{r}

```


```{r}

```


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
